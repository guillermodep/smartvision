<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extractor de Texto con Smart Vision</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@500;600;700&display=swap">
    <style>
        :root {
            /* Colores base */
            --primary-color: #4361ee;
            --primary-light: #5a75f0;
            --primary-dark: #3a55d9;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --info-color: #4361ee;
            --danger-color: #e63946;
            
            /* RGB versions for transparency */
            --primary-color-rgb: 67, 97, 238;
            --secondary-color-rgb: 63, 55, 201;
            --bg-card-rgb: 255, 255, 255;
            
            /* Gradientes */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            --gradient-secondary: linear-gradient(135deg, var(--secondary-color), var(--primary-dark));
            --gradient-success: linear-gradient(135deg, var(--success-color), #56cfe1);
            --gradient-warning: linear-gradient(135deg, var(--warning-color), #ff758f);
            
            /* Variables para modo oscuro/claro */
            --bg-main: #f0f2f5;
            --bg-card: #ffffff;
            --text-main: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        /* Modo oscuro */
        [data-theme="dark"] {
            --bg-main: #121212;
            --bg-card: #1e1e1e;
            --text-main: #f8f9fa;
            --text-secondary: #adb5bd;
            --border-color: #2d2d2d;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --bg-card-rgb: 30, 30, 30;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: var(--text-main);
            padding-top: 30px;
            padding-bottom: 50px;
            transition: all 0.3s ease;
            min-height: 100vh;
            margin: 0;
            position: relative;
            overflow-x: hidden;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
        }
        
        .container {
            max-width: 1140px;
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow-color);
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.8s ease-out forwards;
        }

        [data-theme="dark"] .container {
            background-color: rgba(30, 30, 30, 0.85);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .app-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        
        .app-title {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .app-subtitle {
            color: var(--secondary-color);
            font-weight: 300;
            margin-bottom: 0;
        }
        
        .user-info {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .user-welcome {
            color: var(--secondary-color);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px var(--shadow-color);
            margin-bottom: 25px;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }
        
        .card:hover::before {
            transform: scaleX(1);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px var(--shadow-color);
        }
        
        .card-header {
            background: var(--gradient-primary);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .card-header i {
            margin-right: 10px;
            font-size: 1.2em;
            animation: pulse 2s infinite ease-in-out;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            background-size: 200% 200%;
            border: none;
            padding: 12px 20px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }
        
        .btn-primary:hover {
            background-position: right center;
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(67, 97, 238, 0.4);
        }
        
        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-primary:active::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: ripple 0.6s ease-out;
        }
        
        @keyframes ripple {
            0% {
                width: 0;
                height: 0;
                opacity: 0.5;
            }
            100% {
                width: 300px;
                height: 300px;
                opacity: 0;
            }
        }
        
        .btn-secondary {
            background: var(--gradient-secondary);
            background-size: 200% 200%;
            border: none;
            padding: 10px 15px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(63, 55, 201, 0.3);
        }
        
        .btn-secondary:hover {
            background-position: right center;
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(63, 55, 201, 0.4);
        }
        
        .btn-success {
            background: var(--gradient-success);
            background-size: 200% 200%;
            border: none;
            padding: 10px 15px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(76, 201, 240, 0.3);
        }
        
        .btn-success:hover {
            background-position: right center;
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(76, 201, 240, 0.4);
        }
        
        .btn-danger {
            background: var(--gradient-warning);
            background-size: 200% 200%;
            border: none;
            padding: 10px 15px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(247, 37, 133, 0.3);
        }
        
        .btn-danger:hover {
            background-position: right center;
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(247, 37, 133, 0.4);
        }
        
        .icon-animated {
            transition: all 0.3s ease;
        }
        
        .icon-animated:hover {
            transform: scale(1.2) rotate(5deg);
            color: var(--primary-color);
        }
        
        .preview-container {
            max-width: 100%;
            max-height: 400px;
            overflow: auto;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px dashed #dee2e6;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .preview-container.has-image {
            border: none;
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .result-container {
            max-height: 500px;
            overflow: auto;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: var(--bg-card);
            box-shadow: 0 5px 15px var(--shadow-color);
            transition: all 0.3s ease;
        }

        .text-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .text-item {
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px var(--shadow-color);
            transition: all 0.3s ease;
            transform-style: preserve-3d;
            perspective: 1000px;
            transform: translateZ(0);
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        .text-item:hover {
            transform: translateY(-5px) rotateX(5deg) rotateY(5deg);
            box-shadow: 0 15px 30px var(--shadow-color);
        }

        .text-item.show {
            opacity: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .text-content {
            font-size: 16px;
            margin-bottom: 10px;
            color: var(--text-main);
        }

        .text-confidence {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }

        .confidence-bar {
            height: 6px;
            width: 100%;
            background-color: var(--border-color);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .confidence-level {
            height: 100%;
            border-radius: 3px;
            background: var(--gradient-primary);
            transition: width 0.5s ease;
        }

        .high-confidence {
            background: var(--gradient-success);
        }

        .medium-confidence {
            background: linear-gradient(135deg, #ffd166, #ffaa33);
        }

        .low-confidence {
            background: var(--gradient-warning);
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 48px;
            color: var(--border-color);
            margin-bottom: 15px;
        }
        
        .empty-text {
            font-size: 16px;
            text-align: center;
        }
        
        .file-upload-input {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
        }
        
        .file-name {
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .form-control {
            border-radius: 8px;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }
        
        .alert {
            border-radius: 8px;
            padding: 15px 20px;
        }
        
        .text-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .text-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .text-content {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .text-description {
            margin: 8px 0;
            font-size: 0.9rem;
            color: #6c757d;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .description-label {
            font-weight: 600;
            margin-right: 5px;
            color: #4361ee;
        }
        
        .description-text {
            font-style: italic;
        }
        
        /* Estilos para los números de factura */
        .invoice-number-item {
            background-color: rgba(67, 97, 238, 0.1);
            border-left: 4px solid #4361ee;
            padding: 20px;
        }
        
        .invoice-number-title {
            font-size: 14px;
            font-weight: 600;
            color: #4361ee;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .invoice-number-value {
            font-size: 24px;
            font-weight: 700;
            color: #212529;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }
        
        [data-theme="dark"] .invoice-number-value {
            color: #f8f9fa;
        }
        
        /* Estilos para el análisis de IA con GPT-4o */
        .gpt4o-analysis {
            background-color: rgba(67, 97, 238, 0.05);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .gpt4o-analysis h3 {
            color: #4361ee;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(67, 97, 238, 0.2);
            padding-bottom: 10px;
        }
        
        .gpt4o-analysis h4 {
            color: #4361ee;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .invoice-numbers-section {
            background-color: rgba(67, 97, 238, 0.08);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .full-text-section {
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .full-text-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        [data-theme="dark"] .gpt4o-analysis {
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        [data-theme="dark"] .full-text-section {
            background-color: rgba(33, 37, 41, 0.7);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        [data-theme="dark"] .full-text-content {
            color: #e9ecef;
            background-color: #343a40;
            border-color: #495057;
        }
        
        /* Estilos para el modal de progreso */
        .bg-translucent {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(3px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        [data-theme="dark"] .bg-translucent {
            background-color: rgba(33, 37, 41, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .thinking-container {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.1);
            font-family: monospace;
            backdrop-filter: blur(5px);
        }
        
        [data-theme="dark"] .thinking-container {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .thinking-logs {
            font-size: 14px;
            line-height: 1.5;
            color: #000;
            white-space: pre-wrap;
            text-shadow: 0px 0px 3px rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        
        [data-theme="dark"] .thinking-logs {
            color: #fff;
            text-shadow: 0px 0px 3px rgba(0, 0, 0, 0.8);
        }
        
        .thinking-step {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .thinking-step:before {
            content: '>';
            position: absolute;
            left: 0;
            color: var(--primary-color);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .progress {
            height: 12px;
            border-radius: 6px;
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="dark"] .progress {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .progress-bar {
            background-color: var(--primary-color);
            border-radius: 6px;
        }
        
        .text-confidence {
            font-size: 12px;
            color: #6c757d;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 40px;
            background-color: rgba(var(--bg-card-rgb), 0.5);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            flex-direction: column;
        }

        .file-upload-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(var(--primary-color-rgb), 0.05), transparent);
            background-size: 200% 200%;
            animation: shine 3s infinite linear;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .file-upload-label:hover::before {
            opacity: 1;
        }

        @keyframes shine {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .file-upload-label.highlight {
            border-color: var(--primary-color);
            background-color: rgba(var(--primary-color-rgb), 0.05);
            transform: scale(1.02);
        }

        .file-upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            z-index: 1;
        }

        .file-upload-icon {
            font-size: 64px;
            color: var(--primary-color);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .file-upload-label:hover .file-upload-icon {
            transform: translateY(-5px);
        }

        .file-upload-text {
            color: var(--text-secondary);
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #6c757d;
            font-size: 14px;
        }
        
        .download-options {
            display: none;
        }
        
        /* Skeletons para carga de datos */
        @keyframes pulse-bg {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 0%; }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--bg-card) 25%, var(--border-color) 50%, var(--bg-card) 75%);
            background-size: 200% 100%;
            animation: pulse-bg 1.5s infinite;
            border-radius: 8px;
            height: 20px;
            margin-bottom: 15px;
        }

        .skeleton-text {
            height: 20px;
            width: 100%;
        }

        .skeleton-text:last-child {
            width: 80%;
        }

        .skeleton-card {
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px var(--shadow-color);
            margin-bottom: 15px;
        }

        .skeleton-confidence {
            height: 10px;
            width: 60%;
            margin-top: 10px;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            color: var(--primary-color);
            animation: pulse-spinner 1.5s infinite ease-in-out;
        }
        
        @keyframes pulse-spinner {
            0% { transform: scale(0.95); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }
        
        /* Estilos para el selector de tema oscuro/claro */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
        }

        .theme-switch {
            display: inline-block;
            position: relative;
            width: 60px;
            height: 34px;
        }

        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 5px;
        }

        .slider .fa-sun {
            color: #f1c40f;
            font-size: 14px;
        }

        .slider .fa-moon {
            color: #2c3e50;
            font-size: 14px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            z-index: 1;
        }

        input:checked + .slider {
            background-color: #2c3e50;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }
        
        /* Estilos para las notificaciones */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .toast {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            animation: fadeIn 0.5s ease forwards;
        }
        
        .toast-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .toast-content {
            flex-grow: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .toast-message {
            font-size: 14px;
            color: #6c757d;
        }
        
        .toast.success {
            background-color: #dff0d8;
            border-color: #d6e9c6;
        }
        
        .toast.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .fade-out {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        
        /* Estrellas CSS */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background-color: #fff;
            border-radius: 50%;
            animation: twinkle 4s infinite;
            transition: transform 0.3s ease;
        }
        
        .star.blue {
            background-color: #4361ee;
        }
        
        .star.pink {
            background-color: #f72585;
        }
        
        .star.cyan {
            background-color: #4cc9f0;
        }
        
        @keyframes twinkle {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }

        /* Líneas de conexión entre estrellas */
        .constellation-line {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.1);
            transform-origin: 0 0;
            z-index: -1;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="stars">
        <!-- Las estrellas se generarán con JavaScript -->
    </div>

    <div class="container">
        <div class="app-header">
            <h1 class="app-title">Extractor de Texto con Smart Vision</h1>
            <p class="app-subtitle">Extrae texto de imágenes, tickets, facturas y documentos con inteligencia artificial</p>
            
            <div class="user-info">
                <span class="user-welcome me-2" id="username-display">Usuario</span>
                <div class="theme-switch-wrapper me-3">
                    <label class="theme-switch" for="theme-toggle">
                        <input type="checkbox" id="theme-toggle" />
                        <div class="slider round">
                            <i class="fas fa-sun"></i>
                            <i class="fas fa-moon"></i>
                        </div>
                    </label>
                </div>
                <button class="btn btn-sm btn-danger ms-2" id="logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-upload me-2"></i> Cargar Imagen
                    </div>
                    <div class="card-body">
                        <form id="upload-form" enctype="multipart/form-data">
                            <div class="file-upload">
                                <input type="file" id="file-input" name="file" accept="image/*" class="file-input" style="display: none;" />
                                <label for="file-input" class="file-upload-label">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <span class="upload-text">Arrastra y suelta una imagen aquí<br>o haz clic para seleccionar un archivo</span>
                                </label>
                                <div class="file-name mt-2" id="file-name"></div>
                            </div>
                            <div class="form-group mt-3">
                                <button type="submit" class="btn btn-primary btn-lg w-100" id="extract-button">
                                    <i class="fas fa-magic me-2"></i> Extraer Texto
                                </button>
                                <input type="hidden" name="use_ai_analysis" value="true">
                            </div>
                        </form>
                        
                        <div class="loading mt-4" id="loading">
                            <div class="spinner-border text-primary spinner" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                        
                        <div class="preview-container mt-4" id="preview-container" style="display: none;">
                            <h5 class="mb-3"><i class="fas fa-eye me-2"></i> Vista previa</h5>
                            <div id="image-preview-wrapper" style="text-align: center;">
                                <!-- La imagen se insertará aquí -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-file-alt me-2"></i> Resultados
                    </div>
                    <div class="card-body">
                        <div class="result-container" id="result-container">
                            <div class="empty-state" id="empty-state">
                                <div class="empty-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="empty-text">
                                    Los resultados de la extracción de texto aparecerán aquí
                                </div>
                            </div>
                            <div class="loading" id="loading">
                                <div class="spinner-border text-primary spinner" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                            <div id="text-results" class="text-results"></div>
                        </div>
                        
                        <div class="download-options mt-3" id="download-options" style="display: none;">
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-success flex-grow-1 me-2" id="download-txt">
                                    <i class="fas fa-file-alt me-2 icon-animated"></i> Descargar TXT
                                </button>
                                <button class="btn btn-danger flex-grow-1" id="download-pdf">
                                    <i class="fas fa-file-pdf me-2 icon-animated"></i> Descargar PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal de Progreso -->
        <div class="modal fade" id="progress-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="progress-modal-label" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content bg-translucent">
                    <div class="modal-header border-0">
                        <h5 class="modal-title" id="progress-modal-label"><i class="fas fa-brain me-2"></i>Procesando con IA</h5>
                    </div>
                    <div class="modal-body">
                        <div class="progress mb-4">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                        </div>
                        <div class="thinking-container">
                            <div id="thinking-logs" class="thinking-logs"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Desarrollado con <i class="fas fa-heart" style="color: var(--warning-color);"></i> por Smart Vision Team</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        function checkAuth() {
            const token = localStorage.getItem('smartvision_token');
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }
        
        function displayUsername() {
            const token = localStorage.getItem('smartvision_token');
            if (token) {
                const username = atob(token).split(':')[0];
                document.getElementById('username-display').textContent = username;
            }
        }
        
        function setupLogout() {
            document.getElementById('logout').addEventListener('click', function() {
                localStorage.removeItem('smartvision_token');
                window.location.href = '/login';
            });
        }
        
        // Función para cambiar entre modo claro y oscuro
        function setupThemeToggle() {
            const themeToggle = document.getElementById('theme-toggle');
            
            // Verificar si hay un tema guardado en localStorage
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeToggle.checked = true;
            }
            
            // Manejar cambio de tema
            themeToggle.addEventListener('change', function() {
                if (this.checked) {
                    document.body.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                }
            });
        }
        
        // Generar estrellas con JavaScript y añadir interactividad
        function setupStarBackground() {
            const starsContainer = document.querySelector('.stars');
            const starCount = 200; // Número de estrellas
            const stars = []; // Array para almacenar referencias a las estrellas
            const constellationDistance = 150; // Distancia máxima para conectar estrellas
            let mouseX = 0;
            let mouseY = 0;
            
            // Colores de las estrellas
            const colors = ['', 'blue', 'pink', 'cyan']; // '' para blanco (default)
            
            // Crear estrellas
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                // Asignar color aleatorio
                const colorClass = colors[Math.floor(Math.random() * colors.length)];
                if (colorClass) {
                    star.classList.add(colorClass);
                }
                
                // Posición aleatoria
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                
                // Tamaño aleatorio
                const size = Math.random() * 3 + 1;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                
                // Retraso aleatorio en la animación
                star.style.animationDelay = `${Math.random() * 4}s`;
                
                // Añadir al contenedor
                starsContainer.appendChild(star);
                
                // Guardar referencia y posición
                stars.push({
                    element: star,
                    x: x,
                    y: y,
                    size: size,
                    connections: []
                });
            }
            
            // Crear conexiones entre estrellas cercanas (efecto constelación)
            function createConstellations() {
                // Primero eliminar líneas existentes
                document.querySelectorAll('.constellation-line').forEach(line => line.remove());
                
                for (let i = 0; i < stars.length; i++) {
                    stars[i].connections = [];
                    for (let j = i + 1; j < stars.length; j++) {
                        // Calcular distancia entre estrellas
                        const dx = (stars[i].x - stars[j].x) * window.innerWidth / 100;
                        const dy = (stars[i].y - stars[j].y) * window.innerHeight / 100;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        // Si están lo suficientemente cerca, crear una línea
                        if (distance < constellationDistance) {
                            const line = document.createElement('div');
                            line.classList.add('constellation-line');
                            
                            // Posicionar y dimensionar la línea
                            const x1 = stars[i].x * window.innerWidth / 100;
                            const y1 = stars[i].y * window.innerHeight / 100;
                            const x2 = stars[j].x * window.innerWidth / 100;
                            const y2 = stars[j].y * window.innerHeight / 100;
                            
                            // Calcular longitud y ángulo de la línea
                            const length = Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1));
                            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                            
                            // Aplicar estilos
                            line.style.width = `${length}px`;
                            line.style.height = '1px';
                            line.style.left = `${x1}px`;
                            line.style.top = `${y1}px`;
                            line.style.transform = `rotate(${angle}deg)`;
                            
                            // Añadir al DOM
                            starsContainer.appendChild(line);
                            
                            // Guardar referencia
                            stars[i].connections.push(j);
                        }
                    }
                }
            }
            
            // Crear constelaciones iniciales
            createConstellations();
            
            // Recrear constelaciones al cambiar tamaño de ventana
            window.addEventListener('resize', createConstellations);
            
            // Interactividad con el ratón
            document.addEventListener('mousemove', function(e) {
                mouseX = e.clientX;
                mouseY = e.clientY;
                
                // Mover estrellas ligeramente hacia el cursor
                stars.forEach(star => {
                    const starX = star.x * window.innerWidth / 100;
                    const starY = star.y * window.innerHeight / 100;
                    
                    // Calcular distancia al cursor
                    const dx = mouseX - starX;
                    const dy = mouseY - starY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // Si está cerca del cursor, mover ligeramente
                    if (distance < 200) {
                        const moveX = dx * 0.02;
                        const moveY = dy * 0.02;
                        star.element.style.transform = `translate(${moveX}px, ${moveY}px)`;
                    } else {
                        star.element.style.transform = 'translate(0, 0)';
                    }
                });
            });
        }
        
        // Función para mostrar notificaciones
        function showToast(type, title, message) {
            // Crear contenedor de toasts si no existe
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container';
                document.body.appendChild(toastContainer);
            }
            
            // Crear toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Determinar icono según tipo
            let iconClass = 'fa-info-circle';
            if (type === 'success') iconClass = 'fa-check-circle';
            if (type === 'error') iconClass = 'fa-exclamation-circle';
            
            // Contenido del toast
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${iconClass}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            // Añadir al contenedor
            toastContainer.appendChild(toast);
            
            // Eliminar después de 3.5 segundos
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3500);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;
            
            displayUsername();
            setupLogout();
            setupThemeToggle();
            setupStarBackground();
            
            const uploadForm = document.getElementById('upload-form');
            const previewContainer = document.getElementById('preview-container');
            const imagePreviewWrapper = document.getElementById('image-preview-wrapper');
            const resultContainer = document.getElementById('result-container');
            const loadingIndicator = document.getElementById('loading');
            const fileNameDisplay = document.getElementById('file-name');
            const fileInput = document.getElementById('file-input');
            const downloadOptions = document.getElementById('download-options');
            
            let extractionResults = [];
            
            // Función para mostrar la vista previa de la imagen
            function displayImagePreview(file) {
                if (!file) return;
                
                console.log("Mostrando vista previa para:", file.name);
                
                // Obtener el contenedor de la vista previa
                const imagePreviewWrapper = document.getElementById('image-preview-wrapper');
                if (!imagePreviewWrapper) {
                    console.error("No se encontró el contenedor de vista previa");
                    return;
                }
                
                // Limpiar el contenedor
                imagePreviewWrapper.innerHTML = '';
                
                // Crear un elemento de imagen simple
                const img = document.createElement('img');
                img.style.maxWidth = '100%';
                img.style.maxHeight = '300px';
                img.style.borderRadius = '8px';
                img.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.1)';
                img.alt = 'Vista previa';
                
                // Usar FileReader para cargar la imagen
                const reader = new FileReader();
                
                // Mostrar un indicador de carga mientras se procesa la imagen
                imagePreviewWrapper.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>';
                
                reader.onload = function(e) {
                    // Asignar la imagen cargada al elemento img
                    img.src = e.target.result;
                    
                    // Limpiar el contenedor y añadir la imagen
                    imagePreviewWrapper.innerHTML = '';
                    imagePreviewWrapper.appendChild(img);
                    
                    // Mostrar el contenedor y actualizar el nombre del archivo
                    const previewContainer = document.getElementById('preview-container');
                    if (previewContainer) {
                        previewContainer.style.display = 'block';
                        previewContainer.classList.add('has-image');
                    }
                    
                    const fileNameDisplay = document.getElementById('file-name');
                    if (fileNameDisplay) {
                        fileNameDisplay.textContent = file.name;
                    }
                };
                
                reader.onerror = function(error) {
                    console.error('Error en FileReader:', error);
                    imagePreviewWrapper.innerHTML = '<div class="alert alert-danger">Error al leer la imagen</div>';
                };
                
                // Iniciar la lectura del archivo como Data URL
                reader.readAsDataURL(file);
            }
            
            // Manejar el cambio en el input de archivo
            fileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    displayImagePreview(file);
                }
            });
            
            // Función para mostrar skeletons durante la carga
            function showLoadingSkeletons() {
                const resultsContainer = document.getElementById('text-results');
                resultsContainer.innerHTML = '';
                document.getElementById('empty-state').style.display = 'none';
                
                // Crear 4 skeleton cards
                for (let i = 0; i < 4; i++) {
                    const skeletonCard = document.createElement('div');
                    skeletonCard.className = 'skeleton-card';
                    
                    skeletonCard.innerHTML = `
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-confidence"></div>
                    `;
                    
                    resultsContainer.appendChild(skeletonCard);
                }
            }
            
            // Función para mostrar el modal de progreso
            function showProgressModal() {
                const progressModal = new bootstrap.Modal(document.getElementById('progress-modal'));
                progressModal.show();
                
                // Resetear la barra de progreso y los logs
                const progressBar = document.getElementById('progress-bar');
                const thinkingLogs = document.getElementById('thinking-logs');
                progressBar.style.width = '0%';
                progressBar.setAttribute('aria-valuenow', '0');
                thinkingLogs.innerHTML = '';
                
                return {
                    progressModal,
                    progressBar,
                    thinkingLogs
                };
            }
            
            // Función para añadir un paso al log de thinking
            function addThinkingStep(thinkingLogs, step) {
                const stepElement = document.createElement('div');
                stepElement.className = 'thinking-step';
                stepElement.textContent = step;
                thinkingLogs.appendChild(stepElement);
                thinkingLogs.scrollTop = thinkingLogs.scrollHeight;
            }
            
            // Función para actualizar la barra de progreso
            function updateProgress(progressBar, value) {
                progressBar.style.width = `${value}%`;
                progressBar.setAttribute('aria-valuenow', value);
            }
            
            // Pasos del procesamiento
            const processingSteps = [
                "Inicializando procesamiento de imagen...",
                "Cargando modelo de visión artificial...",
                "Analizando contenido de la imagen...",
                "Extrayendo texto visible...",
                "Identificando elementos clave (fechas, importes, números de factura)...",
                "Procesando estructura del documento...",
                "Aplicando análisis contextual...",
                "Verificando números de factura y recibos...",
                "Organizando resultados...",
                "Finalizando procesamiento..."
            ];
            
            uploadForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const formData = new FormData(uploadForm);
                if (!formData.get('file').name) {
                    alert('Por favor, selecciona una imagen primero.');
                    return;
                }
                
                // Siempre usar análisis con IA (es el default ahora)
                formData.set('use_ai_analysis', 'true');
                
                // Mostrar el modal de progreso
                const { progressModal, progressBar, thinkingLogs } = showProgressModal();
                
                // Simular los pasos del procesamiento
                let currentStep = 0;
                const totalSteps = processingSteps.length;
                
                // Mostrar el primer paso inmediatamente
                addThinkingStep(thinkingLogs, processingSteps[currentStep]);
                updateProgress(progressBar, (currentStep / totalSteps) * 100);
                
                // Mostrar los siguientes pasos con intervalos
                const stepInterval = setInterval(() => {
                    currentStep++;
                    
                    if (currentStep < totalSteps) {
                        addThinkingStep(thinkingLogs, processingSteps[currentStep]);
                        updateProgress(progressBar, (currentStep / totalSteps) * 100);
                    } else {
                        clearInterval(stepInterval);
                    }
                }, 800);
                
                // Realizar la solicitud al servidor
                fetch('/extract-text', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Asegurar que se muestren todos los pasos
                    clearInterval(stepInterval);
                    
                    for (let i = currentStep; i < totalSteps; i++) {
                        addThinkingStep(thinkingLogs, processingSteps[i]);
                    }
                    
                    updateProgress(progressBar, 100);
                    
                    // Añadir mensaje de finalización
                    addThinkingStep(thinkingLogs, "¡Procesamiento completado con éxito!");
                    
                    // Cerrar el modal después de un breve retraso
                    setTimeout(() => {
                        progressModal.hide();
                        
                        // Limpiar el indicador de carga antiguo
                        loadingIndicator.style.display = 'none';
                    }, 1000);
                    
                    if (data.error) {
                        resultContainer.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>${data.error}</div>`;
                        downloadOptions.style.display = 'none';
                        return;
                    }
                    
                    // Verificar si es un análisis de IA con GPT-4o
                    if (data.success === true && data.full_text) {
                        // Mostrar el texto completo extraído y los números de factura
                        const fullText = data.full_text;
                        const invoiceNumbers = data.invoice_numbers || [];
                        
                        let resultHtml = `
                            <div class="gpt4o-analysis">
                                <h3 class="mb-3"><i class="fas fa-robot me-2"></i>Texto Extraído con IA</h3>
                        `;
                        
                        // Mostrar los números de factura si se encontraron
                        if (invoiceNumbers.length > 0) {
                            resultHtml += `
                                <div class="invoice-numbers-section mb-4">
                                    <h4 class="mb-3"><i class="fas fa-receipt me-2"></i>Números de Factura Detectados</h4>
                            `;
                            
                            invoiceNumbers.forEach((item, index) => {
                                const confidence = parseFloat(item.confidence) || 0;
                                let confidenceClass = 'low-confidence';
                                
                                if (confidence >= 0.8) {
                                    confidenceClass = 'high-confidence';
                                } else if (confidence >= 0.5) {
                                    confidenceClass = 'medium-confidence';
                                }
                                
                                resultHtml += `
                                    <div class="invoice-number-item mb-3">
                                        <div class="invoice-number-title">Número de Factura ${index + 1}</div>
                                        <div class="invoice-number-value">${item.invoice_number}</div>
                                        <div class="text-confidence">
                                            <span>Confianza: ${(confidence * 100).toFixed(1)}%</span>
                                        </div>
                                        <div class="confidence-bar">
                                            <div class="confidence-level ${confidenceClass}" style="width: ${confidence * 100}%"></div>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            resultHtml += `</div>`;
                        } else {
                            resultHtml += `
                                <div class="alert alert-info mb-4">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No se encontraron números de factura en esta imagen.
                                </div>
                            `;
                        }
                        
                        // Mostrar el texto completo extraído
                        resultHtml += `
                            <div class="full-text-section">
                                <h4 class="mb-3"><i class="fas fa-file-alt me-2"></i>Texto Completo Extraído</h4>
                                <div class="full-text-content">${fullText.replace(/\n/g, '<br>')}</div>
                            </div>
                        `;
                        
                        resultHtml += `</div>`;
                        resultContainer.innerHTML = resultHtml;
                        
                        // Guardar los datos para descargar
                        extractionResults = {
                            fullText: fullText,
                            invoiceNumbers: invoiceNumbers
                        };
                        downloadOptions.style.display = 'block';
                    } else if (data.status === 'succeeded' && data.results && data.results.length > 0) {
                        // Mostrar resultados normales
                        extractionResults = data.results;
                        displayResults(data.results);
                        downloadOptions.style.display = 'block';
                    } else if (Array.isArray(data) && data.length > 0) {
                        // Para mantener compatibilidad con el formato anterior
                        extractionResults = data;
                        displayResults(data);
                        downloadOptions.style.display = 'block';
                    } else {
                        resultContainer.innerHTML = `<div class="empty-state">
                            <i class="fas fa-search empty-icon"></i>
                            <p class="empty-text">No se pudo extraer texto de esta imagen.</p>
                        </div>`;
                    }
                })
                .catch(error => {
                    loadingIndicator.style.display = 'none';
                    resultContainer.innerHTML = `<div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error: ${error.message}
                    </div>`;
                    downloadOptions.style.display = 'none';
                });
            });
            
            // Función para mostrar los resultados de la extracción
            function displayResults(results) {
                const resultsContainer = document.getElementById('text-results');
                resultsContainer.innerHTML = '';
                
                if (results.length === 0) {
                    document.getElementById('empty-state').style.display = 'flex';
                    return;
                }
                
                document.getElementById('empty-state').style.display = 'none';
                
                // Verificar si los resultados son números de factura
                const hasInvoiceNumbers = results.some(item => item.categories && item.categories.includes('numero_factura'));
                
                results.forEach((item, index) => {
                    const confidence = parseFloat(item.confidence) || 0;
                    let confidenceClass = 'low-confidence';
                    
                    if (confidence >= 0.8) {
                        confidenceClass = 'high-confidence';
                    } else if (confidence >= 0.5) {
                        confidenceClass = 'medium-confidence';
                    }
                    
                    const textItem = document.createElement('div');
                    textItem.className = 'text-item';
                    textItem.style.animationDelay = `${index * 0.1}s`;
                    
                    // Verificar si es un número de factura
                    const isInvoiceNumber = item.categories && item.categories.includes('numero_factura');
                    
                    if (isInvoiceNumber) {
                        // Mostrar el número de factura de forma destacada
                        const invoiceNumber = item.invoice_number || item.text;
                        textItem.classList.add('invoice-number-item');
                        
                        textItem.innerHTML = `
                            <div class="invoice-number-title">Número de Factura</div>
                            <div class="invoice-number-value">${invoiceNumber}</div>
                            <div class="text-confidence">
                                <span>Confianza: ${(confidence * 100).toFixed(1)}%</span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-level ${confidenceClass}" style="width: ${confidence * 100}%"></div>
                            </div>
                        `;
                    } else {
                        // Añadir la descripción del dato extraído
                        const description = item.description || 'Información adicional del ticket';
                        const categories = item.categories ? item.categories.join(', ') : 'otro';
                        
                        textItem.innerHTML = `
                            <div class="text-content">${item.text}</div>
                            <div class="text-description">
                                <span class="description-label">Tipo de dato:</span> 
                                <span class="description-text">${description}</span>
                            </div>
                            <div class="text-confidence">
                                <span>Confianza: ${(confidence * 100).toFixed(1)}%</span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-level ${confidenceClass}" style="width: ${confidence * 100}%"></div>
                            </div>
                        `;
                    }
                    
                    resultsContainer.appendChild(textItem);
                    
                    // Añadir animación de entrada
                    setTimeout(() => {
                        textItem.classList.add('show');
                    }, index * 100);
                });
                
                // Mostrar notificación de éxito
                if (hasInvoiceNumbers) {
                    showToast('success', 'Número de Factura Detectado', `Se ha identificado el número de factura en la imagen.`);
                } else {
                    showToast('info', 'Texto Extraído', `No se ha detectado un número de factura claro. Se muestran todos los datos extraídos.`);
                }
            }
            
            document.getElementById('download-txt').addEventListener('click', function() {
                if (!extractionResults) {
                    alert('No hay texto para descargar');
                    return;
                }
                
                let textContent = 'TEXTO EXTRAÍDO CON SMART VISION\n';
                textContent += '==============================\n\n';
                
                // Verificar si los datos vienen del nuevo formato de GPT-4o
                if (extractionResults.fullText) {
                    // Formato nuevo con texto completo y números de factura
                    const invoiceNumbers = extractionResults.invoiceNumbers || [];
                    
                    if (invoiceNumbers.length > 0) {
                        textContent += 'NÚMEROS DE FACTURA DETECTADOS:\n';
                        textContent += '--------------------------------\n\n';
                        
                        invoiceNumbers.forEach((item, index) => {
                            textContent += `Número de Factura ${index + 1}: ${item.invoice_number}\n`;
                            textContent += `   Confianza: ${(parseFloat(item.confidence) * 100).toFixed(1)}%\n\n`;
                        });
                    } else {
                        textContent += 'No se encontraron números de factura.\n\n';
                    }
                    
                    textContent += 'TEXTO COMPLETO EXTRAÍDO:\n';
                    textContent += '--------------------------------\n\n';
                    textContent += extractionResults.fullText;
                    
                } else if (Array.isArray(extractionResults)) {
                    // Formato antiguo (array de resultados)
                    if (extractionResults.length === 0) {
                        alert('No hay texto para descargar');
                        return;
                    }
                    
                    // Verificar si los datos son números de factura del análisis avanzado
                    if (extractionResults[0] && 'invoice_number' in extractionResults[0]) {
                        textContent += 'NÚMEROS DE FACTURA DETECTADOS:\n';
                        textContent += '--------------------------------\n\n';
                        
                        extractionResults.forEach((item, index) => {
                            textContent += `Número de Factura ${index + 1}: ${item.invoice_number}\n`;
                            textContent += `   Confianza: ${(parseFloat(item.confidence) * 100).toFixed(1)}%\n\n`;
                        });
                    } else {
                        // Verificar si hay números de factura en el formato antiguo
                        const invoiceNumbers = extractionResults.filter(item => 
                            item.categories && item.categories.includes('numero_factura')
                        );
                        
                        if (invoiceNumbers.length > 0) {
                            textContent += 'NÚMEROS DE FACTURA DETECTADOS:\n';
                            textContent += '--------------------------------\n\n';
                            
                            invoiceNumbers.forEach((item, index) => {
                                const invoiceNumber = item.invoice_number || item.text;
                                textContent += `Número de Factura ${index + 1}: ${invoiceNumber}\n`;
                                textContent += `   Confianza: ${(parseFloat(item.confidence) * 100).toFixed(1)}%\n\n`;
                            });
                        } else {
                            textContent += 'DATOS EXTRAÍDOS DEL DOCUMENTO:\n';
                            textContent += '--------------------------------\n\n';
                            
                            extractionResults.forEach((item, index) => {
                                const description = item.description || 'Información adicional del ticket';
                                textContent += `${index + 1}. ${item.text}\n`;
                                textContent += `   Tipo de dato: ${description}\n`;
                                textContent += `   Confianza: ${(parseFloat(item.confidence) * 100).toFixed(1)}%\n\n`;
                            });
                        }
                    }
                }
                
                downloadFile(textContent, 'texto_extraido.txt', 'text/plain');
            });
            
            document.getElementById('download-pdf').addEventListener('click', function() {
                if (!extractionResults) {
                    alert('No hay texto para descargar');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(16);
                doc.text('Texto Extraído con Smart Vision', 20, 20);
                
                doc.setFontSize(12);
                let y = 30;
                
                // Verificar si los datos vienen del nuevo formato de GPT-4o
                if (extractionResults.fullText) {
                    // Formato nuevo con texto completo y números de factura
                    const invoiceNumbers = extractionResults.invoiceNumbers || [];
                    const fullText = extractionResults.fullText;
                    
                    if (invoiceNumbers.length > 0) {
                        doc.setFontSize(14);
                        doc.setTextColor(67, 97, 238);
                        doc.text('Números de Factura Detectados', 20, y);
                        y += 10;
                        
                        invoiceNumbers.forEach((item, index) => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            doc.setFontSize(12);
                            doc.setTextColor(67, 97, 238);
                            doc.text(`Número de Factura ${index + 1}:`, 20, y);
                            y += 7;
                            
                            doc.setFontSize(14);
                            doc.setTextColor(0, 0, 0);
                            doc.text(item.invoice_number, 25, y);
                            y += 7;
                            
                            doc.setFontSize(10);
                            doc.setTextColor(100, 100, 100);
                            doc.text(`Confianza: ${(parseFloat(item.confidence) * 100).toFixed(1)}%`, 25, y);
                            y += 10;
                        });
                    } else {
                        doc.setFontSize(14);
                        doc.setTextColor(67, 97, 238);
                        doc.text('No se encontraron números de factura', 20, y);
                        y += 10;
                    }
                    
                    // Añadir el texto completo extraído
                    if (y > 240) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setTextColor(67, 97, 238);
                    doc.text('Texto Completo Extraído', 20, y);
                    y += 10;
                    
                    // Dividir el texto en líneas para que quepa en el PDF
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    
                    const lines = doc.splitTextToSize(fullText, 170);
                    
                    // Añadir líneas al PDF, creando nuevas páginas si es necesario
                    for (let i = 0; i < lines.length; i++) {
                        if (y > 280) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        doc.text(lines[i], 20, y);
                        y += 6;
                    }
                    
                } else if (Array.isArray(extractionResults)) {
                    // Formato antiguo (array de resultados)
                    if (extractionResults.length === 0) {
                        alert('No hay texto para descargar');
                        return;
                    }
                    
                    // Verificar si los datos son números de factura del análisis avanzado
                    if (extractionResults[0] && 'invoice_number' in extractionResults[0]) {
                        // Mostrar números de factura del análisis avanzado
                        extractionResults.forEach((item, index) => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            doc.setFontSize(14);
                            doc.setTextColor(67, 97, 238); // Azul para el título
                            doc.text(`Número de Factura ${index + 1}:`, 20, y);
                            y += 10;
                            
                            doc.setFontSize(16);
                            doc.setTextColor(0, 0, 0);
                            doc.text(item.invoice_number, 20, y);
                            y += 10;
                            
                            doc.setFontSize(10);
                            doc.setTextColor(100, 100, 100);
                            doc.text(`Confianza: ${(parseFloat(item.confidence) * 100).toFixed(1)}%`, 20, y);
                            
                            doc.setFontSize(12);
                            doc.setTextColor(0, 0, 0);
                            y += 20;
                        });
                    } else {
                        // Verificar si hay números de factura en el formato antiguo
                        const invoiceNumbers = extractionResults.filter(item => 
                            item.categories && item.categories.includes('numero_factura')
                        );
                        
                        if (invoiceNumbers.length > 0) {
                            // Si hay números de factura, mostrar solo esos
                            invoiceNumbers.forEach((item, index) => {
                                if (y > 270) {
                                    doc.addPage();
                                    y = 20;
                                }
                                
                                const invoiceNumber = item.invoice_number || item.text;
                                
                                doc.setFontSize(14);
                                doc.setTextColor(67, 97, 238); // Azul para el título
                                doc.text(`Número de Factura ${index + 1}:`, 20, y);
                                y += 10;
                                
                                doc.setFontSize(16);
                                doc.setTextColor(0, 0, 0);
                                doc.text(invoiceNumber, 20, y);
                                y += 10;
                                
                                doc.setFontSize(10);
                                doc.setTextColor(100, 100, 100);
                                doc.text(`Confianza: ${(parseFloat(item.confidence) * 100).toFixed(1)}%`, 20, y);
                                
                                doc.setFontSize(12);
                                doc.setTextColor(0, 0, 0);
                                y += 20;
                            });
                        } else {
                            // Si no hay números de factura, mostrar todos los datos
                            doc.text('Texto Extraído con Smart Vision', 20, 20);
                            
                            extractionResults.forEach((item, index) => {
                                if (y > 270) {
                                    doc.addPage();
                                    y = 20;
                                }
                                
                                doc.text(`${index + 1}. ${item.text}`, 20, y);
                                y += 7;
                                doc.setFontSize(10);
                                doc.setTextColor(100, 100, 100);
                                
                                // Añadir la descripción del dato
                                const description = item.description || 'Información adicional del ticket';
                                doc.text(`Tipo de dato: ${description}`, 25, y);
                                y += 5;
                                
                                doc.text(`Confianza: ${(parseFloat(item.confidence) * 100).toFixed(1)}%`, 25, y);
                                doc.setFontSize(12);
                                doc.setTextColor(0, 0, 0);
                                y += 12;
                            });
                        }
                    }
                }
                
                const now = new Date();
                const dateStr = now.toLocaleDateString();
                const timeStr = now.toLocaleTimeString();
                doc.setFontSize(10);
                doc.text(`Generado el ${dateStr} a las ${timeStr}`, 20, 280);
                
                doc.save('texto_extraido.pdf');
            });
            
            function downloadFile(content, fileName, contentType) {
                const blob = new Blob([content], { type: contentType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            const dropArea = document.querySelector('.file-upload-label');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.classList.add('highlight');
            }
            
            function unhighlight() {
                dropArea.classList.remove('highlight');
            }
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                fileInput.files = files;
                
                // Mostrar la vista previa de la imagen directamente
                if (files.length > 0) {
                    displayImagePreview(files[0]);
                }
            }
        });
    </script>
</body>
</html>
